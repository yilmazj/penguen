<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nihilist Penguin: GTA Mode</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#eef2f3">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>

    <style>
        /* CSS BLOKU */
        body { margin: 0; overflow: hidden; background-color: #eef2f3; font-family: sans-serif; user-select: none; -webkit-user-select: none; }
        
        #canvas-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; 
        }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Tıklamalar arkaya geçsin */
            display: flex; justify-content: center; align-items: center; z-index: 10;
        }

        #start-screen {
            background: rgba(255, 255, 255, 0.9);
            padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
            pointer-events: auto; /* Sadece burası tıklanabilir olsun */
            transition: opacity 0.5s;
        }

        button {
            background: #000; color: #fff; border: none; padding: 15px 50px;
            font-size: 18px; border-radius: 50px; cursor: pointer; font-weight: bold;
        }
        
        #joystick-zone {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; display: none;
        }
    </style>
</head>
<body>

    <div id="canvas-container"></div>
    <div id="joystick-zone"></div>

    <div id="ui-layer">
        <div id="start-screen">
            <h1 style="margin:0 0 10px 0; font-weight:300; letter-spacing:2px;">NIHILIST</h1>
            <p style="color:#666; margin-bottom:30px;">Sadece yürü. Varış yok.</p>
            <button id="start-btn">BAŞLA</button>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT BLOKU ---
        
        let scene, camera, renderer;
        let penguinGroup, societyGroup;
        let joystickManager;
        // Hareket verisi: active (basılıyor mu), angle (nereye basılıyor)
        let moveData = { active: false, angle: 0 };
        let isGameRunning = false;

        const colors = {
            fog: 0xeef2f3,
            ground: 0xeef2f3,
            black: 0x1a1a1a,
            white: 0xffffff,
            mtn: 0xdce4e8
        };

        // Başlatma Butonu
        document.getElementById('start-btn').addEventListener('click', () => {
            const ui = document.getElementById('start-screen');
            ui.style.opacity = '0';
            setTimeout(() => ui.style.display = 'none', 500);
            
            document.getElementById('joystick-zone').style.display = 'block';
            isGameRunning = true;
            
            // Joystick'i başlat
            initJoystick();

            // Tam ekran (Telefonda adres çubuğunu gizler)
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => {});
            }
        });

        init3D();
        animate();

        function init3D() {
            // 1. Sahne
            scene = new THREE.Scene();
            scene.background = new THREE.Color(colors.fog);
            scene.fog = new THREE.FogExp2(colors.fog, 0.012);

            // 2. Kamera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 7, -12); // Arkadan yukarıdan bakış

            // 3. Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // 4. Işık
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.6);
            scene.add(hemiLight);
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(50, 100, 50);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // 5. Zemin
            const planeGeo = new THREE.PlaneGeometry(2000, 2000);
            const planeMat = new THREE.MeshPhongMaterial({ color: colors.ground, shininess: 0 });
            const ground = new THREE.Mesh(planeGeo, planeMat);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);

            // 6. Objeler
            createMountains();
            createPlayer();
            createSociety();

            // Kamera hemen penguene baksın
            camera.lookAt(penguinGroup.position);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // --- Joystick Mantığı (DÜZELTİLDİ) ---
        function initJoystick() {
            joystickManager = nipplejs.create({
                zone: document.getElementById('joystick-zone'),
                mode: 'dynamic',
                color: 'white',
                size: 120
            });

            joystickManager.on('move', (evt, data) => {
                // Joystick oynatıldığı sürece hareket var
                if (data && data.angle) {
                    moveData.active = true;
                    moveData.angle = data.angle.radian; // Radyan cinsinden açı
                }
            });

            joystickManager.on('end', () => {
                moveData.active = false; // Bırakınca dur
            });
        }

        // --- Oyun Döngüsü ---
        function update() {
            if (!isGameRunning) return;

            const speed = 0.25;

            if (moveData.active) {
                // 1. Hedef Açıyı Hesapla
                // Joystick açısı (X eksenine göre) + 90 derece (öne dönmesi için)
                // NippleJS'de sağ 0, yukarı 90 (PI/2). ThreeJS'de ileri -Z.
                // Bu yüzden bir dönüşüm yapıyoruz.
                let targetRotation = moveData.angle + Math.PI / 2; 

                // Pengueni yavaşça o yöne döndür (Lerp rotasyonu)
                // Kuaterniyon kullanarak en kısa yoldan dönmesini sağla
                const targetQuaternion = new THREE.Quaternion();
                targetQuaternion.setFromAxisAngle(new THREE.Vector3(0, 1, 0), targetRotation);
                penguinGroup.quaternion.slerp(targetQuaternion, 0.15); // 0.15 dönüş hızı

                // 2. İleri Git (Baktığı yöne değil, joystick yönüne gitmesi daha iyi ama
                // burada "baktığı yöne yürüme" hissi daha gerçekçi)
                const direction = new THREE.Vector3(0, 0, 1); // Varsayılan ileri
                direction.applyQuaternion(penguinGroup.quaternion); // Dönüşü uygula
                penguinGroup.position.add(direction.multiplyScalar(speed));

                // 3. Yürüme Efekti (Sallanma)
                penguinGroup.children[0].rotation.z = Math.sin(Date.now() * 0.015) * 0.1;
                penguinGroup.children[0].position.y = Math.abs(Math.sin(Date.now() * 0.015)) * 0.1;
            } else {
                // Dururken düzelt
                penguinGroup.children[0].rotation.z = 0;
                penguinGroup.children[0].position.y = 0;
            }

            // --- Kamera Takibi ---
            // Kamerayı penguenin arkasına ama biraz gecikmeli (smooth) getir
            const idealOffset = new THREE.Vector3(0, 6, -12); // Penguenin arkası
            idealOffset.applyQuaternion(penguinGroup.quaternion);
            idealOffset.add(penguinGroup.position);
            
            camera.position.lerp(idealOffset, 0.1);
            camera.lookAt(penguinGroup.position);

            // --- Nihilizm (Society Kaçışı) ---
            const dist = penguinGroup.position.distanceTo(societyGroup.position);
            if (dist < 60) {
                // Society grubunu oyuncudan uzaklaştır
                // Oyuncu nereye gidiyorsa society de oraya kaysın (aynı hızda)
                if (moveData.active) {
                    const direction = new THREE.Vector3(0, 0, 1);
                    direction.applyQuaternion(penguinGroup.quaternion);
                    societyGroup.position.add(direction.multiplyScalar(speed * 1.1)); // Biraz daha hızlı kaçsınlar
                }
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            update();
            renderer.render(scene, camera);
        }

        // --- Helper: Nesne Yaratıcılar ---
        function createPlayer() {
            penguinGroup = new THREE.Group();
            const mesh = createPenguenMesh();
            penguinGroup.add(mesh);
            scene.add(penguinGroup);
        }

        function createSociety() {
            societyGroup = new THREE.Group();
            societyGroup.position.set(0, 0, -100); // Uzakta başlasınlar
            for(let i=0; i<6; i++) {
                const p = createPenguenMesh();
                p.position.set((Math.random()-0.5)*30, 0, (Math.random()-0.5)*30);
                p.rotation.y = Math.PI; // Bize baksınlar
                societyGroup.add(p);
            }
            scene.add(societyGroup);
        }

        function createPenguenMesh() {
            const grp = new THREE.Group();
            const matBlack = new THREE.MeshStandardMaterial({color:0x1a1a1a});
            const matWhite = new THREE.MeshStandardMaterial({color:0xffffff});
            const matOrange = new THREE.MeshStandardMaterial({color:0xffa500});

            // Gövde
            const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.5, 1.2, 4, 8), matBlack);
            body.position.y = 0.8; body.castShadow = true; grp.add(body);
            // Göbek
            const belly = new THREE.Mesh(new THREE.CapsuleGeometry(0.35, 0.9, 4, 8), matWhite);
            belly.position.set(0, 0.75, 0.25); grp.add(belly);
            // Kafa
            const head = new THREE.Mesh(new THREE.SphereGeometry(0.42, 16, 16), matBlack);
            head.position.y = 1.7; grp.add(head);
            // Gaga
            const beak = new THREE.Mesh(new THREE.ConeGeometry(0.1, 0.35, 8), matOrange);
            beak.rotation.x = Math.PI/2; beak.position.set(0, 1.7, 0.5); grp.add(beak);
            // Kanatlar
            const wing = new THREE.Mesh(new THREE.BoxGeometry(1, 0.1, 0.3), matBlack);
            wing.position.set(0, 1.3, 0); grp.add(wing);

            return grp;
        }

        function createMountains() {
            for(let i=0; i<40; i++) {
                const h = 20 + Math.random()*50;
                const m = new THREE.Mesh(
                    new THREE.ConeGeometry(10+Math.random()*30, h, 4),
                    new THREE.MeshStandardMaterial({color: 0xdce4e8, flatShading:true})
                );
                const a = Math.random()*Math.PI*2;
                const r = 150 + Math.random()*200;
                m.position.set(Math.cos(a)*r, h/2-5, Math.sin(a)*r);
                scene.add(m);
            }
        }
    </script>
</body>
</html>
